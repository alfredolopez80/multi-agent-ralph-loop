#!/usr/bin/env bash
# Pre-commit hook: Security validation with gitleaks and semgrep
# VERSION: 1.0.0
#
# This hook prevents commits that contain:
# - API keys, tokens, secrets (detected by gitleaks)
# - Security vulnerabilities (detected by semgrep)

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v '^\.git' || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo -e "${YELLOW}üîí Running security checks...${NC}"

# ============================================
# 1. Gitleaks: Scan for secrets/API keys
# ============================================
echo -e "${YELLOW}  ‚Üí Scanning for secrets with gitleaks...${NC}"

# Create a temporary file with staged content
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

GIT_ROOT=$(git rev-parse --show-toplevel)

# Copy staged files to temp directory
while IFS= read -r file; do
    if [ -f "$GIT_ROOT/$file" ]; then
        mkdir -p "$TEMP_DIR/$(dirname "$file")"
        cp "$GIT_ROOT/$file" "$TEMP_DIR/$file"
    fi
done <<< "$STAGED_FILES"

# Run gitleaks on the temporary directory
if gitleaks detect --source "$TEMP_DIR" --no-git --no-banner --log-level=error 2>&1 | grep -q "leaks found"; then
    echo -e "${RED}‚ùå GITLEAKS DETECTED SECRETS!${NC}"
    echo -e "${RED}Commit blocked. Run 'gitleaks detect --source .' for details.${NC}"
    exit 1
fi

echo -e "${GREEN}  ‚úÖ No secrets detected${NC}"

# ============================================
# 2. Semgrep: Scan for security vulnerabilities
# ============================================
echo -e "${YELLOW}  ‚Üí Scanning for vulnerabilities with semgrep...${NC}"

# Run semgrep on staged files only
SEMGREP_OUTPUT=$(semgrep --config auto --error --severity=ERROR \
    --exclude=node_modules \
    --exclude=__pycache__ \
    --exclude=.git \
    --quiet \
    $STAGED_FILES 2>&1 || true)

if [ -n "$SEMGREP_OUTPUT" ]; then
    echo -e "${RED}‚ùå SEMGREP DETECTED SECURITY ISSUES!${NC}"
    echo "$SEMGREP_OUTPUT"
    echo -e "${RED}Commit blocked. Fix security issues before committing.${NC}"
    exit 1
fi

echo -e "${GREEN}  ‚úÖ No security issues detected${NC}"

# ============================================
# All checks passed
# ============================================
echo -e "${GREEN}üîí Security checks passed!${NC}"
exit 0
