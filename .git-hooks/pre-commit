#!/bin/bash
# pre-commit hook for multi-agent-ralph-loop
# VERSION: 2.87.0
# Purpose: Validate hooks, skills, and architecture before commit
#
# CRITICAL FORMAT RULES (per official Claude Code docs):
# - PostToolUse/PreToolUse/UserPromptSubmit: {"continue": true/false}
# - Stop hooks ONLY: {"decision": "approve"/"block"}
# - The string "continue" is NEVER valid for the "decision" field
#
# VALIDATION PHASES:
# 1. Hook JSON format validation
# 2. Skills unification validation (if skills changed)
# 3. Architecture documentation validation

set -uo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

REPO_ROOT="$(git rev-parse --show-toplevel)"
ERRORS=0

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  Pre-commit Validation v2.87.0${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""

#######################################
# Phase 1: Hook JSON Format Validation
#######################################
STAGED_HOOKS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.claude/hooks/.*\.(sh|py)$' || true)

if [[ -n "$STAGED_HOOKS" ]]; then
    echo -e "${YELLOW}[Phase 1] Validating Claude Code hook JSON formats${NC}"

    for hook_file in $STAGED_HOOKS; do
        [[ ! -f "$hook_file" ]] && continue

        hook_name=$(basename "$hook_file")

        # CRITICAL: "decision": "continue" is NEVER valid
        if grep -qE '"decision":\s*"continue"' "$hook_file"; then
            echo -e "  ${RED}✗ $hook_name: Uses invalid {\"decision\": \"continue\"}${NC}"
            ((ERRORS++))
            continue
        fi

        echo -e "  ${GREEN}✓ $hook_name${NC}"
    done
else
    echo -e "${YELLOW}[Phase 1] Skipped (no hooks changed)${NC}"
fi

#######################################
# Phase 2: Skills Unification Validation
#######################################
STAGED_SKILLS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.claude/skills/.*SKILL\.md$' || true)

if [[ -n "$STAGED_SKILLS" ]]; then
    echo ""
    echo -e "${YELLOW}[Phase 2] Validating skills unification${NC}"

    SKILLS_TEST="$REPO_ROOT/tests/unit/test-skills-unification-v2.87.sh"

    if [[ -x "$SKILLS_TEST" ]]; then
        # Run quick validation (not verbose, just check pass/fail)
        if "$SKILLS_TEST" > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Skills unification validated${NC}"
        else
            echo -e "  ${RED}✗ Skills unification test failed${NC}"
            echo -e "  ${YELLOW}  Run for details: $SKILLS_TEST --verbose${NC}"
            ((ERRORS++))
        fi
    else
        echo -e "  ${YELLOW}⚠ Skills test script not found or not executable${NC}"
    fi
else
    echo -e "${YELLOW}[Phase 2] Skipped (no skills changed)${NC}"
fi

#######################################
# Phase 3: Architecture Documentation Check
#######################################
STAGED_DOCS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^docs/architecture/.*\.md$' || true)

if [[ -n "$STAGED_DOCS" ]]; then
    echo ""
    echo -e "${YELLOW}[Phase 3] Validating architecture documentation${NC}"

    for doc in $STAGED_DOCS; do
        if [[ -f "$doc" ]]; then
            # Check for required metadata
            if grep -qE "^\*\*Date\*\*:|^\*\*Version\*\*:" "$doc" 2>/dev/null; then
                echo -e "  ${GREEN}✓ $(basename "$doc")${NC}"
            else
                echo -e "  ${YELLOW}⚠ $(basename "$doc"): Missing metadata header${NC}"
            fi
        fi
    done
else
    echo -e "${YELLOW}[Phase 3] Skipped (no architecture docs changed)${NC}"
fi

#######################################
# Phase 4: CLAUDE.md Version Check
#######################################
STAGED_CLAUDE_MD=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^CLAUDE\.md$' || true)

if [[ -n "$STAGED_CLAUDE_MD" ]]; then
    echo ""
    echo -e "${YELLOW}[Phase 4] Validating CLAUDE.md version${NC}"

    CURRENT_VERSION=$(grep -E "^# Multi-Agent Ralph v" "$REPO_ROOT/CLAUDE.md" 2>/dev/null | head -1 | sed 's/^# Multi-Agent Ralph v//' | tr -d ' ')

    if [[ -n "$CURRENT_VERSION" ]]; then
        echo -e "  ${GREEN}✓ CLAUDE.md version: $CURRENT_VERSION${NC}"
    else
        echo -e "  ${YELLOW}⚠ Could not detect version in CLAUDE.md${NC}"
    fi
fi

#######################################
# Phase 5: Skills Symlink Validation
#######################################
STAGED_SKILL_DIRS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.claude/skills/[^/]+/' | head -1 || true)

if [[ -n "$STAGED_SKILL_DIRS" ]]; then
    echo ""
    echo -e "${YELLOW}[Phase 5] Validating skills symlinks${NC}"

    SYMLINK_TEST="$REPO_ROOT/tests/unit/test-skills-symlinks-v2.87.sh"

    if [[ -x "$SYMLINK_TEST" ]]; then
        # Run quick validation
        if "$SYMLINK_TEST" > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Skills symlinks validated${NC}"
        else
            echo -e "  ${YELLOW}⚠ Skills symlink test has warnings (run -v for details)${NC}"
            # Don't block on symlink warnings, just notify
        fi
    else
        echo -e "  ${YELLOW}⚠ Symlink test script not found${NC}"
    fi
else
    echo ""
    echo -e "${YELLOW}[Phase 5] Skipped (no skills changed)${NC}"
fi

#######################################
# Summary
#######################################
echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

if [[ $ERRORS -gt 0 ]]; then
    echo -e "${RED}COMMIT BLOCKED: $ERRORS validation error(s)${NC}"
    echo ""
    echo "Fix the issues above and try again."
    echo "For detailed skills validation: tests/unit/test-skills-unification-v2.87.sh --verbose"
    exit 1
fi

echo -e "${GREEN}✓ All validations passed${NC}"
exit 0
